<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çš®å…‹æ•ç´”é»ç®¡ç†å™¨ v7</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* æ­¤è™•çœç•¥èˆ‡ v6 ç›¸åŒçš„ CSS ä»¥ç¯€çœç©ºé–“ï¼Œè«‹ä¿ç•™ä½ åŸå§‹æª”æ¡ˆä¸­çš„ <style> å…§å®¹ */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Nunito', -apple-system, BlinkMacSystemFont, sans-serif; background: linear-gradient(180deg, #87CEEB 0%, #B0E0F0 40%, #98E4C9 70%, #7BC97B 100%); min-height: 100vh; color: #2D5016; padding-bottom: 100px; position: relative; overflow-x: hidden; }
        .header { background: linear-gradient(180deg, #87CEEB 0%, #B8E4F0 100%); padding: 30px 16px 40px; text-align: center; position: relative; overflow: hidden; border-radius: 0 0 40px 40px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .header-cloud { position: absolute; background: #fff; border-radius: 50%; opacity: 0.9; }
        .header-cloud::before, .header-cloud::after { content: ''; position: absolute; background: #fff; border-radius: 50%; }
        .header-cloud-1 { width: 80px; height: 30px; top: 15px; left: 10%; animation: cloud-drift 20s linear infinite; }
        .header-cloud-1::before { width: 40px; height: 40px; top: -20px; left: 10px; }
        .header-cloud-1::after { width: 50px; height: 35px; top: -15px; left: 35px; }
        .header-cloud-2 { width: 100px; height: 35px; top: 20px; right: 15%; animation: cloud-drift 25s linear infinite; animation-delay: -5s; }
        .header-cloud-2::before { width: 50px; height: 50px; top: -25px; left: 15px; }
        .header-cloud-2::after { width: 60px; height: 40px; top: -18px; left: 45px; }
        .header-cloud-3 { width: 60px; height: 24px; top: 50px; left: 50%; transform: translateX(-50%); animation: cloud-drift 18s linear infinite; animation-delay: -10s; opacity: 0.7; }
        .header-cloud-3::before { width: 30px; height: 30px; top: -15px; left: 8px; }
        .header-cloud-3::after { width: 35px; height: 25px; top: -10px; left: 28px; }
        @keyframes cloud-drift { 0% { transform: translateX(-20px); } 50% { transform: translateX(20px); } 100% { transform: translateX(-20px); } }
        .header-content { position: relative; z-index: 10; }
        .seedling-icon { font-size: 3rem; display: inline-block; animation: seedling-bounce 2s ease-in-out infinite; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1)); }
        @keyframes seedling-bounce { 0%, 100% { transform: translateY(0) rotate(-5deg); } 25% { transform: translateY(-8px) rotate(0deg); } 50% { transform: translateY(0) rotate(5deg); } 75% { transform: translateY(-4px) rotate(0deg); } }
        .header h1 { font-size: 1.5rem; font-weight: 800; color: #4A7C23; margin-top: 8px; text-shadow: 1px 1px 0 rgba(255,255,255,0.5); }
        .header p { font-size: 0.9rem; color: #5A8F33; font-weight: 600; margin-top: 4px; }
        .sync-status { font-size: 0.75rem; margin-top: 8px; padding: 4px 12px; border-radius: 12px; display: inline-block; }
        .sync-status.syncing { background: #FFF3E0; color: #E65100; }
        .sync-status.synced { background: #E8F5E9; color: #2E7D32; }
        .sync-status.error { background: #FFEBEE; color: #C62828; }
        .bg-cloud { position: fixed; background: #fff; border-radius: 50%; opacity: 0.6; z-index: 0; pointer-events: none; }
        .bg-cloud::before, .bg-cloud::after { content: ''; position: absolute; background: #fff; border-radius: 50%; }
        .bg-cloud-1 { width: 120px; height: 45px; top: 25%; left: -150px; animation: float-cloud 40s linear infinite; }
        .bg-cloud-1::before { width: 60px; height: 60px; top: -30px; left: 20px; }
        .bg-cloud-1::after { width: 70px; height: 50px; top: -25px; left: 55px; }
        .bg-cloud-2 { width: 90px; height: 35px; top: 40%; left: -120px; animation: float-cloud 35s linear infinite; animation-delay: -15s; }
        .bg-cloud-2::before { width: 45px; height: 45px; top: -22px; left: 12px; }
        .bg-cloud-2::after { width: 55px; height: 38px; top: -18px; left: 40px; }
        .bg-cloud-3 { width: 100px; height: 40px; top: 55%; left: -130px; animation: float-cloud 45s linear infinite; animation-delay: -25s; opacity: 0.5; }
        .bg-cloud-3::before { width: 50px; height: 50px; top: -25px; left: 15px; }
        .bg-cloud-3::after { width: 60px; height: 42px; top: -20px; left: 45px; }
        @keyframes float-cloud { from { transform: translateX(0); } to { transform: translateX(calc(100vw + 200px)); } }
        .flowers-container { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; pointer-events: none; z-index: 2; display: flex; justify-content: space-around; align-items: flex-end; padding: 0 10px 8px; }
        .flower { font-size: 20px; animation: sway 3s ease-in-out infinite; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }
        .flower:nth-child(odd) { animation-delay: 0s; }
        .flower:nth-child(even) { animation-delay: 0.5s; }
        @keyframes sway { 0%, 100% { transform: rotate(-8deg); } 50% { transform: rotate(8deg); } }
        .container { padding: 16px; max-width: 600px; margin: 0 auto; position: relative; z-index: 1; }
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 12px; background: rgba(255,255,255,0.9); border-radius: 20px; margin-bottom: 16px; margin-top: -20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; z-index: 10; }
        .stat-item { text-align: center; padding: 10px 4px; border-radius: 14px; transition: transform 0.2s; }
        .stat-item:active { transform: scale(0.95); }
        .stat-icon { font-size: 1.3rem; margin-bottom: 2px; }
        .stat-number { font-size: 1.4rem; font-weight: 800; }
        .stat-label { font-size: 11px; font-weight: 700; opacity: 0.9; }
        .stat-item.flower { background: linear-gradient(135deg, #FFE4EC 0%, #FFB6C1 100%); color: #C71585; }
        .stat-item.pikmin { background: linear-gradient(135deg, #E8F5E9 0%, #A5D6A7 100%); color: #2E7D32; }
        .stat-item.mushroom { background: linear-gradient(135deg, #FFF3E0 0%, #FFCC80 100%); color: #E65100; }
        .stat-item.postcard { background: linear-gradient(135deg, #E3F2FD 0%, #90CAF9 100%); color: #1565C0; }
        .search-section { background: rgba(255,255,255,0.9); border-radius: 24px; padding: 16px; margin-bottom: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .search-input-wrapper { position: relative; margin-bottom: 12px; }
        .search-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); font-size: 18px; }
        .search-input { width: 100%; padding: 14px 16px 14px 48px; border: 3px solid #E8F5E9; border-radius: 16px; font-size: 16px; font-family: inherit; font-weight: 600; background: #fff; color: #2D5016; transition: border-color 0.2s; }
        .search-input:focus { outline: none; border-color: #81C784; }
        .filter-group { margin-bottom: 12px; }
        .filter-label { font-size: 12px; font-weight: 700; color: #666; margin-bottom: 8px; display: block; }
        .filter-row { display: flex; gap: 10px; }
        .filter-row .region-select-wrapper { flex: 1; }
        .filter-tabs { display: flex; gap: 8px; flex-wrap: wrap; }
        .filter-tab { padding: 10px 14px; border: 3px solid transparent; border-radius: 16px; font-size: 13px; font-weight: 700; font-family: inherit; cursor: pointer; transition: all 0.2s; background: #f0f0f0; color: #666; }
        .filter-tab.active { background: #fff; transform: scale(1.05); }
        .filter-tab[data-type="all"].active { border-color: #81C784; color: #2D5016; }
        .filter-tab[data-type="flower"].active { border-color: #FF6B9D; color: #C71585; background: #FFE4EC; }
        .filter-tab[data-type="pikmin"].active { border-color: #66BB6A; color: #2E7D32; background: #E8F5E9; }
        .filter-tab[data-type="mushroom"].active { border-color: #FF8A65; color: #E65100; background: #FFF3E0; }
        .filter-tab[data-type="postcard"].active { border-color: #42A5F5; color: #1565C0; background: #E3F2FD; }
        .region-select-wrapper { position: relative; }
        .region-select { width: 100%; padding: 12px 16px; border: 3px solid #E8F5E9; border-radius: 16px; font-size: 14px; font-family: inherit; font-weight: 600; background: #fff; color: #2D5016; cursor: pointer; appearance: none; }
        .region-select:focus { outline: none; border-color: #9575CD; }
        .region-select-wrapper::after { content: 'â–¼'; position: absolute; right: 16px; top: 50%; transform: translateY(-50%); font-size: 12px; color: #666; pointer-events: none; }
        .filter-summary { background: linear-gradient(135deg, #EDE7F6 0%, #E8F5E9 100%); padding: 10px 14px; border-radius: 12px; font-size: 13px; font-weight: 600; color: #5E35B1; margin-top: 12px; display: none; }
        .filter-summary.active { display: block; }
        .import-section { background: rgba(255,255,255,0.9); border-radius: 20px; padding: 16px; margin-bottom: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .import-title { font-size: 14px; font-weight: 700; margin-bottom: 12px; color: #2D5016; }
        .import-btns { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; } /* æ”¹ç‚ºä¸‰æ¬„ */
        .btn-import { padding: 10px 4px; background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%); border: 3px dashed #81C784; border-radius: 14px; color: #2E7D32; font-size: 12px; font-weight: 700; font-family: inherit; cursor: pointer; transition: all 0.2s; text-align: center; }
        .btn-import:active { transform: scale(0.97); }
        .spot-list { display: flex; flex-direction: column; gap: 12px; }
        /* å…¶é¤˜æ¨£å¼çœç•¥... */
    </style>
</head>
<body>
    <div class="bg-cloud bg-cloud-1"></div>
    <div class="bg-cloud bg-cloud-2"></div>
    <div class="bg-cloud bg-cloud-3"></div>
    <div class="flowers-container">
        <div class="flower">ğŸŒ¼</div><div class="flower">â€</div><div class="flower">ğŸŒ¼</div><div class="flower">â€</div><div class="flower">ğŸŒ¼</div>
        <div class="flower">â€</div><div class="flower">ğŸŒ¼</div><div class="flower">â€</div><div class="flower">ğŸŒ¼</div><div class="flower">â€</div>
    </div>
    
    <div class="header">
        <div class="header-cloud header-cloud-1"></div>
        <div class="header-cloud header-cloud-2"></div>
        <div class="header-cloud header-cloud-3"></div>
        <div class="header-content">
            <div class="seedling-icon">ğŸŒ±</div>
            <h1>ç´”é»ç®¡ç†å™¨</h1>
            <p>æ”¶è—ä½ çš„çš®å…‹æ•ç§˜å¢ƒ</p>
            <div class="sync-status synced" id="syncStatus">â˜ï¸ å·²é€£ç·š</div>
        </div>
    </div>

    <div class="container">
        <div class="stats" id="stats">
            <div class="stat-item flower"><div class="stat-icon">ğŸŒ¸</div><div class="stat-number" id="stat-flower">0</div><div class="stat-label">å¤§èŠ±</div></div>
            <div class="stat-item pikmin"><div class="stat-icon">ğŸŒ±</div><div class="stat-number" id="stat-pikmin">0</div><div class="stat-label">çš®å…‹æ•</div></div>
            <div class="stat-item mushroom"><div class="stat-icon">ğŸ„</div><div class="stat-number" id="stat-mushroom">0</div><div class="stat-label">è˜‘è‡</div></div>
            <div class="stat-item postcard"><div class="stat-icon">ğŸ </div><div class="stat-number" id="stat-postcard">0</div><div class="stat-label">æ˜ä¿¡ç‰‡</div></div>
        </div>

        <div class="search-section">
            <div class="search-input-wrapper">
                <span class="search-icon">ğŸ”</span>
                <input type="text" class="search-input" id="searchInput" placeholder="æœå°‹ç´”é»...">
            </div>
            <div class="filter-group">
                <label class="filter-label">ğŸŒ åœ°å€ç¯©é¸</label>
                <div class="filter-row">
                    <div class="region-select-wrapper"><select class="region-select" id="countryFilter"><option value="all">å…¨éƒ¨åœ‹å®¶</option></select></div>
                    <div class="region-select-wrapper"><select class="region-select" id="cityFilter"><option value="all">å…¨éƒ¨ç¸£å¸‚</option></select></div>
                </div>
            </div>
            <div class="filter-group">
                <label class="filter-label">ğŸ·ï¸ é¡å‹ç¯©é¸</label>
                <div class="filter-tabs">
                    <button class="filter-tab active" data-type="all">å…¨éƒ¨</button>
                    <button class="filter-tab" data-type="flower">ğŸŒ¸ å¤§èŠ±</button>
                    <button class="filter-tab" data-type="pikmin">ğŸŒ± çš®å…‹æ•</button>
                    <button class="filter-tab" data-type="mushroom">ğŸ„ è˜‘è‡</button>
                    <button class="filter-tab" data-type="postcard">ğŸ  æ˜ä¿¡ç‰‡</button>
                </div>
            </div>
            <div class="filter-summary" id="filterSummary"></div>
        </div>

        <div class="import-section">
            <div class="import-title">ğŸ“¦ è³‡æ–™ç®¡ç†</div>
            <div class="import-btns">
                <button class="btn-import" id="btnExportJson">ğŸ“¤ åŒ¯å‡º JSON</button>
                <button class="btn-import" id="btnExportGpx">ğŸ“ åŒ¯å‡º GPX</button>
                <button class="btn-import" id="btnImportJson">ğŸ“¥ åŒ¯å…¥ JSON</button> <input type="file" id="fileInput" accept=".json" style="display: none;"> </div>
        </div>

        <div class="spot-list" id="spotList"></div>
    </div>

    <div class="fab-container">
        <button class="fab fab-refresh" id="btnRefresh" title="é‡æ–°è¼‰å…¥">ğŸ”„</button>
        <button class="fab fab-add" id="btnAdd" title="æ–°å¢ç´”é»">+</button>
    </div>

    <script>
        // Supabase é…ç½®
        const SUPABASE_URL = 'https://iojmxiijtvmjglodauai.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlvam14aWlqdHZtamdsb2RhdWFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMzM5MDYsImV4cCI6MjA4NTgwOTkwNn0.4rnjTDXmCH77KwO-1GeZlTKn9xwBrhOJQkQ--FjxQk0';

        // (ä¿ç•™ supabaseRequest å’ŒåŸæœ‰ State)
        async function supabaseRequest(method, endpoint, body = null) {
            const options = {
                method,
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': method === 'POST' ? 'return=representation' : undefined
                }
            };
            if (body) options.body = JSON.stringify(body);
            const response = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`, options);
            if (!response.ok) throw new Error(`API Error: ${response.status}`);
            const text = await response.text();
            return text ? JSON.parse(text) : null;
        }

        let spots = [];
        // ... å…¶ä»–è®Šæ•¸èˆ‡åˆå§‹åŒ–ä»£ç¢¼ ...

        // (å°‡ä»¥ä¸‹åŠŸèƒ½é‚è¼¯åŠ å…¥åˆ°åŸæœ¬çš„ <script> ä¸­)

        const btnImportJson = document.getElementById('btnImportJson');
        const fileInput = document.getElementById('fileInput');

        // é»æ“Šã€ŒåŒ¯å…¥ JSONã€æŒ‰éˆ•è§¸ç™¼éš±è—çš„ file input
        btnImportJson.addEventListener('click', () => {
            fileInput.click();
        });

        // è™•ç†æª”æ¡ˆè®€å–èˆ‡åŒ¯å…¥
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    
                    if (!Array.isArray(importedData)) {
                        throw new Error('JSON æ ¼å¼éŒ¯èª¤ï¼šæ‡‰ç‚ºé™£åˆ—');
                    }

                    if (!confirm(`ç¢ºå®šè¦åŒ¯å…¥ ${importedData.length} å€‹ç´”é»å—ï¼Ÿ`)) return;

                    setSyncStatus('syncing', 'â³ åŒ¯å…¥ä¸­...');

                    // æº–å‚™ä¹¾æ·¨çš„è³‡æ–™ï¼ˆéæ¿¾æ‰èˆŠ ID å’Œæ™‚é–“ï¼Œè®“ Supabase é‡æ–°ç”Ÿæˆï¼‰
                    const cleanData = importedData.map(item => {
                        const { id, created_at, ...rest } = item;
                        return rest;
                    });

                    // æ‰¹æ¬¡åŒ¯å…¥åˆ° Supabase
                    await supabaseRequest('POST', 'spots', cleanData);

                    showToast(`ğŸ‰ æˆåŠŸåŒ¯å…¥ ${cleanData.length} å€‹ç´”é»ï¼`);
                    await loadSpots(); // é‡æ–°æ•´ç†é é¢è³‡æ–™

                } catch (error) {
                    console.error('Import error:', error);
                    showToast('âŒ åŒ¯å…¥å¤±æ•—ï¼šæ ¼å¼ä¸æ­£ç¢º');
                    setSyncStatus('error', 'âŒ åŒ¯å…¥å¤±æ•—');
                } finally {
                    fileInput.value = ''; // æ¸…ç©ºé¸æ“‡ï¼Œé¿å…é‡è¤‡é¸æ“‡åŒä¸€æª”æ¡ˆä¸è§¸ç™¼
                }
            };
            reader.readAsText(file);
        });

        // (åŸæœ¬çš„å…¶ä»–å‡½æ•¸å¦‚ loadSpots, renderSpots, showToast... è«‹ä¿ç•™)
        // ... 
    </script>
</body>
</html>